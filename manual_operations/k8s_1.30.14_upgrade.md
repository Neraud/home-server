# K8S 1.30.14 upgrades

## Master-1

```bash
echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.asc] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /" > /etc/apt/sources.list.d/kubernetes.list
apt-get update
apt-get install -y --allow-change-held-packages kubeadm=1.30.14-1.1

kubeadm upgrade plan

kubeadm upgrade apply v1.30.14
```

## other nodes

```bash
echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.asc] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /" > /etc/apt/sources.list.d/kubernetes.list
apt-get update
apt-get install -y --allow-change-held-packages kubeadm=1.30.14-1.1

kubeadm upgrade node
```

## all nodes

```bash
# kubectl drain <node-to-drain> --ignore-daemonsets

apt-get install -y --allow-change-held-packages kubelet=1.30.14-1.1 kubectl=1.30.14-1.1

echo "deb [signed-by=/etc/apt/keyrings/cri-o-apt-keyring.gpg] https://pkgs.k8s.io/addons:/cri-o:/stable:/v1.30/deb/ /" > /etc/apt/sources.list.d/cri-o.list

# Workaround for cri-o and conmon conflict
# See https://github.com/cri-o/cri-o/issues/8515#issuecomment-2610189959

apt-get install -y --allow-change-held-packages -o Dpkg::Options::="--force-overwrite" cri-o=1.30.10-1.1
apt-get remove conmon podman

systemctl daemon-reload
systemctl restart kubelet
```

To finish the cri-o and conmon conflict: Each node needs to be rebooted, then `apt install podman && apt autoremove`.

## ansible

Run role `kubernetes_node_preinstall` and `crio` to make sure the proper packages are held.
