---
- name: Build and deploy Concourse
  ansible.builtin.import_tasks: ../../app_base/tasks/build-and-deploy.yml
  vars:
    app_name: dev-concourse

# In case we redeploy Concourse, the old version can still be available before the new one stats
# Wait a bit to make sure the old one has been terminated
- name: Wait a bit ...
  ansible.builtin.pause:
    seconds: 10

- name: Wait for Concourse Web to be available
  kubernetes.core.k8s_info:
    kind: Deployment
    namespace: "dev-concourse"
    name: web
    kubeconfig: "{{ kubeconfig_path }}"
    context: "{{ kubeconfig_context }}"
  register: k8s_wait
  until: k8s_wait.resources[0].status.readyReplicas | default(0) > 0
  retries: 30
  delay: 5

- name: Download Concourse fly CLI
  ansible.builtin.get_url:
    url: "http://{{ kubernetes_concourse_web_ip }}:8080/api/v1/cli?arch=amd64&platform=linux"
    dest: "/usr/local/bin/"
    headers:
      Host: "concourse.dev.intra.{{ web_base_domain }}"
    validate_certs: no
    mode: 0755

- name: Check if Concourse fly CLI is properly configured
  ansible.builtin.command: fly --target cluster status
  changed_when: no
  failed_when: no
  register: concourse_fly_status

- name: Configure Concourse fly CLI
  ansible.builtin.command: fly login \
    --target cluster \
    --team-name main \
    --username={{ concourse_ansible_username }} \
    --password={{ concourse_ansible_password }} \
    --concourse-url http://{{ kubernetes_concourse_web_ip }}:8080
  when: concourse_fly_status.rc != 0
