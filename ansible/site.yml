---

- name: Prepare all hosts
  hosts: all
  roles:
    - common
    - common-apt
    - firewall
    - usb-serial

- name: Configure DNS server
  hosts: kubernetes_masters
  roles:
    - dnsmasq

- name: Configure DNS clients
  hosts: all
  roles:
    - dns-client

- name: Prepare Kubernetes members
  hosts: kubernetes
  roles:
    - kubernetes-ansible
    - docker
    - kubernetes-common
    - local-lvm

- name: Prepare GlusterFS hosts
  hosts: glusterfs
  roles:
    - glusterfs

- name: Prepare GlusterFS servers
  hosts: glusterfs_servers
  roles:
    - glusterfs-server-install
    - glusterfs-server-configure

- name: Prepare GlusterFS servers
  hosts: glusterfs_clients
  roles:
    - glusterfs-client

- name: Provision Kubernetes masters
  hosts: kubernetes_masters
  roles:
    - {
        role: openssl-pki,
        tags: openssl-pki
      }
    - {
        role: nginx,
        tags: nginx
      }
    - fail2ban
    - kubernetes-master

- name: Provision Kubernetes nodes
  hosts: kubernetes_nodes
  roles:
    - kubernetes-node

- name: Prepare storage
  hosts: kubernetes
  roles:
    - storage-prepare

- name: Provision Kubernetes applications
  hosts: kubernetes_masters
  roles:
    - kubernetes-infra
    - kubernetes-storage
    - {
        role: kubernetes-apps,
        tags: kubernetes-apps
      }
