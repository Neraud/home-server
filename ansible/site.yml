---

- name: Prepare all hosts
  hosts: all
  roles:
    - common
    - common-apt
    - firewall
    - usb-serial

- name: Configure DNS server
  hosts: kubernetes_masters
  roles:
    - dnsmasq

- name: Prepare Kubernetes members
  hosts: kubernetes
  roles:
    - kubernetes-ansible
    - docker
    - kubernetes-common

- name: Provision Kubernetes masters
  hosts: kubernetes_masters
  roles:
    - {
        role: openssl-pki,
        tags: openssl-pki
      }
    - {
        role: nginx,
        tags: nginx
      }
    - fail2ban
    - kubernetes-master

- name: Provision Kubernetes nodes
  hosts: kubernetes_nodes
  roles:
    - kubernetes-node
    - {
        role: kubernetes-storage,
        tags: kubernetes-storage
      }

- name: Provision Kubernetes applications
  hosts: kubernetes_masters
  roles:
    - kubernetes-infra
    - {
        role: kubernetes-apps,
        tags: kubernetes-apps
      }
