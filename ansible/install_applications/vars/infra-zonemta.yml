---
# To avoid loops inside zonemta
_zonemta_var_loader:
  base_image:
    repo: "docker.io"
    name: "library/node"
    tag: "17.7.2-alpine3.15"
  # 3.2.4+ has issues with the API
  # Each API call (prometheus metrics included) returns a 500
  # 3.3.0+ crashes when a /metrics request is received : https://github.com/zone-eu/zone-mta/issues/291
  # Still happens with 3.4.1
  version: 3.2.3
  namespace: "infra-zonemta"

zonemta:
  enabled: "{{ zonemta_enabled | default(True) }}"

  namespace: "{{ _zonemta_var_loader.namespace }}"
  base_image: "{{ _zonemta_var_loader.base_image }}"
  private_image:
    repo: "{{ docker_private_registry.url }}"
    name: "zonemta"
    tag: "node-{{ _zonemta_var_loader.base_image.tag }}-{{ _zonemta_var_loader.version }}-custom"
  version: "{{ _zonemta_var_loader.version }}"
  repo:
    name: "zone-eu/zone-mta"
    release: "v{{ _zonemta_var_loader.version }}"

  labels_def:
    app.kubernetes.io/name: zonemta
    app.kubernetes.io/component: server

  labels_desc:
    app.kubernetes.io/version: "{{ _zonemta_var_loader.version }}-custom"
    app.kubernetes.io/part-of: zonemta

  container:
    requests_cpu: "{{ zonemta_container_requests_cpu | default('25m') }}"
    # ZoneMTA runs multiple node processes, be sure to have at least 5 times 'max-old-space-size' (set in nodejs_max_memory), and more if you use more processes
    requests_memory: "{{ zonemta_container_requests_memory | default('160Mi') }}"
    limits_cpu: "{{ zonemta_container_limits_cpu | default('100m') }}"
    limits_memory: "{{ zonemta_container_limits_memory | default('160Mi') }}"

  nodejs_max_memory: "{{ zonemta_nodejs_max_memory | default('32') }}"
  smtp_servername: "{{ zonemta_smtp_servername | default('zonemta.' + _zonemta_var_loader.namespace + '.svc.cluster.local') }}"

  feeder:
    authentication_enabled: "{{ zonemta_feeder_authentication_enabled | default(true) }}"
    authentication_username: "{{ zonemta_feeder_authentication_username | default('smtp') }}"
    authentication_password: "{{ zonemta_feeder_authentication_password | default('clear_password') }}"

  forward:
    # Forward to Mailhog by default
    mta_host: "{{ zonemta_forward_mta_host | default(mailhog.servername) }}"
    mta_port: "{{ zonemta_forward_mta_port | default(1025) }}"
    mta_auth_enabled: "{{ zonemta_forward_mta_auth_enabled | default(false) }}"
    mta_user: "{{ zonemta_forward_mta_user | default('') }}"
    mta_password: "{{ zonemta_forward_mta_password | default('') }}"

# To avoid loops inside zonemta_mongo
_zonemta_mongo_var_loader:
  base_image:
    repo: "docker.io"
    name: "library/mongo"
    tag: "5.0.9-focal"

zonemta_mongo:
  base_image: "{{ _zonemta_mongo_var_loader.base_image }}"
  private_image:
    repo: "{{ docker_private_registry.url }}"
    name: "zonemta-{{ _zonemta_mongo_var_loader.base_image.name | regex_replace('.*/', '') }}"
    tag: "{{ _zonemta_mongo_var_loader.base_image.tag }}"

  labels_def:
    app.kubernetes.io/name: zonemta
    app.kubernetes.io/component: mongo

  labels_desc:
    app.kubernetes.io/version: "{{ _zonemta_mongo_var_loader.base_image.tag }}"
    app.kubernetes.io/part-of: zonemta

  container:
    requests_cpu: "{{ zonemta_mongo_container_requests_cpu | default('25m') }}"
    requests_memory: "{{ zonemta_mongo_container_requests_memory | default('384Mi') }}"
    limits_cpu: "{{ zonemta_mongo_container_limits_cpu | default('100m') }}"
    limits_memory: "{{ zonemta_mongo_container_limits_memory | default('384Mi') }}"

  root_user: "{{ zonemta_mongo_root_user | default('root') }}"
  root_password: "{{ zonemta_mongo_root_password | default('clear_password') }}"
  user: "{{ zonemta_mongo_user | default('zonemta') }}"
  database: "{{ zonemta_mongo_database | default('zonemta') }}"
  password: "{{ zonemta_mongo_password | default('clear_password') }}"

# To avoid loops inside zonemta_redis
_zonemta_redis_var_loader:
  base_image:
    repo: "docker.io"
    name: "library/redis"
    tag: "7.0.3-alpine3.16"

zonemta_redis:
  base_image: "{{ _zonemta_redis_var_loader.base_image }}"
  private_image:
    repo: "{{ docker_private_registry.url }}"
    name: "zonemta-{{ _zonemta_redis_var_loader.base_image.name | regex_replace('.*/', '') }}"
    tag: "{{ _zonemta_redis_var_loader.base_image.tag }}"

  labels_def:
    app.kubernetes.io/name: zonemta
    app.kubernetes.io/component: redis

  labels_desc:
    app.kubernetes.io/version: "{{ _zonemta_redis_var_loader.base_image.tag }}"
    app.kubernetes.io/part-of: zonemta

  container:
    requests_cpu: "{{ zonemta_redis_container_requests_cpu | default('25m') }}"
    requests_memory: "{{ zonemta_redis_container_requests_memory | default('32Mi') }}"
    limits_cpu: "{{ zonemta_redis_container_limits_cpu | default('75m') }}"
    limits_memory: "{{ zonemta_redis_container_limits_memory | default('32Mi') }}"

  health_username: "{{ blocky_redis_health_username | default('health') }}"
  username: "{{ zonemta_redis_username | default('zonemta') }}"
  password: "{{ zonemta_redis_password | default('clear_password') }}"
