---

# To avoid loops inside ttrss
_ttrss_var_loader:
  base_image:
    name: "linuxserver/tt-rss"
    # Keep the image version in sync with the ttrss_pgsql.schema_url variable
    tag: "amd64-19.8-ls28"

ttrss:
  enabled: "{{ ttrss_enabled | default(True) }}"

  base_image: "{{ _ttrss_var_loader.base_image }}"

  container:
    image: "{{ docker_registry.url }}/{{ _ttrss_var_loader.base_image.name | regex_replace('.*/', '') }}:{{ _ttrss_var_loader.base_image.tag }}-custom"
    requests_cpu: "{{ ttrss_container_requests_cpu | default('100m') }}"
    requests_memory: "{{ ttrss_container_requests_memory | default('64Mi') }}"
    limits_cpu: "{{ ttrss_container_limits_cpu | default('200m') }}"
    limits_memory: "{{ ttrss_container_limits_memory | default('64Mi') }}"

  context_root: "{{ ttrss_context_root | default('/') }}"
   
  ldap:
    servername: "{{ ttrss_ldap_servername | default(openldap.ldap.servername) }}"
    users_dn: "{{ ttrss_ldap_users_dn | default(openldap.ldap.structure_users_ou_dn) }}"
    manager_dn: "{{ ttrss_ldap_manager_dn | default(openldap.ldap.readonly_user_dn) }}"
    manager_password: "{{ ttrss_ldap_manager_password | default(openldap.ldap.readonly_user_password) }}"
    group: "{{ ttrss_ldap_group }}"
  
  smtp:
    host: "{{ ttrss_smtp_host | default(zonemta.smtp_servername) }}"
    port: "{{ ttrss_smtp_port | default(587) }}"
    user: "{{ ttrss_smtp_user | default(zonemta.feeder.authentication_username) }}"
    password: "{{ ttrss_smtp_password | default(zonemta.feeder.authentication_password) }}"
    #  ssl, tls or empty
    secure: "{{ ttrss_smtp_secure | default('tls') }}"
    from: "{{ ttrss_smtp_from | default('noreply@' + web_base_domain) }}"
    displayName: "{{ ttrss_smtp_displayName | default('Tiny Tiny RSS') }}"



# To avoid loops inside ttrss_pgsql
_ttrss_pgsql_var_loader:
  base_image:
    name: "postgres"
    tag: "11.1-alpine"

ttrss_pgsql:
  base_image: "{{ _ttrss_pgsql_var_loader.base_image }}"

  container:
    image: "{{ docker_registry.url }}/tt-rss-{{ _ttrss_pgsql_var_loader.base_image.name | regex_replace('.*/', '') }}:{{ _ttrss_pgsql_var_loader.base_image.tag }}"
    requests_cpu: "{{ ttrss_pgsql_container_requests_cpu | default('250m') }}"
    requests_memory: "{{ ttrss_pgsql_container_requests_memory | default('256Mi') }}"
    limits_cpu: "{{ ttrss_pgsql_container_limits_cpu | default('500m') }}"
    limits_memory: "{{ ttrss_pgsql_container_limits_memory | default('256Mi') }}"

  user: "{{ ttrss_pgsql_user | default('ttrss') }}"
  database: "{{ ttrss_pgsql_database | default('ttrss') }}"
  password: "{{ ttrss_pgsql_password | default('clear_password') }}"
  # Keep the schema URL in sync with the image version in _ttrss_var_loader.base_image.tag
  schema_url: 'https://git.tt-rss.org/fox/tt-rss/raw/19.8/schema/ttrss_schema_pgsql.sql'
  schema_path_temp: /tmp/tt-rss-schema.sql
