---
# To avoid loops inside ttrss
_ttrss_var_loader:
  namespace: "web-ttrss"
  base_image:
    repo: "docker.io"
    name: "library/php"
    # TTRSS has issues with PHP 8.1 (eg: PHP Fatal error:  Uncaught Error: Class "ORM" not found in /opt/ttrss/classes/logger/sql.php)
    tag: "8.0.19-apache-buster"
  commit: 68e49203d1

ttrss:
  enabled: "{{ ttrss_enabled | default(True) }}"

  namespace: "{{ _ttrss_var_loader.namespace }}"
  base_image: "{{ _ttrss_var_loader.base_image }}"
  private_image:
    repo: "{{ docker_private_registry.url }}"
    name: "ttrss-{{ _ttrss_var_loader.base_image.name | regex_replace('.*/', '') }}"
    tag: "{{ _ttrss_var_loader.commit }}-{{ _ttrss_var_loader.base_image.tag }}"
  commit: "{{ _ttrss_var_loader.commit }}"

  app_backup:
    name: web-ttrss
    repository: "{{ restic_apps_backup_repository }}"
    apps_to_stop:
      - name: ttrss-web
        namespace: "{{ _ttrss_var_loader.namespace }}"
        type: statefulset
        replicas: 1
      - name: ttrss-job
        namespace: "{{ _ttrss_var_loader.namespace }}"
        type: statefulset
        replicas: 1
    gluster_volumes:
      - ttrss-data

  labels_def:
    app.kubernetes.io/name: ttrss
    app.kubernetes.io/component: ttrss

  labels_web_def:
    app.kubernetes.io/name: ttrss
    app.kubernetes.io/component: web

  labels_job_def:
    app.kubernetes.io/name: ttrss
    app.kubernetes.io/component: job

  labels_desc:
    app.kubernetes.io/version: "{{ _ttrss_var_loader.commit }}-{{ _ttrss_var_loader.base_image.tag }}"
    app.kubernetes.io/part-of: ttrss

  container:
    requests_cpu: "{{ ttrss_container_requests_cpu | default('25m') }}"
    requests_memory: "{{ ttrss_container_requests_memory | default('64Mi') }}"
    limits_cpu: "{{ ttrss_container_limits_cpu | default('250m') }}"
    limits_memory: "{{ ttrss_container_limits_memory | default('64Mi') }}"

  context_root: "{{ ttrss_context_root | default('') }}"

  plugins:
    data_migration:
      repo_url: "https://git-gitea.tt-rss.org/fox/ttrss-data-migration"
      branch: master
      commit: 40bb223288
    auth_ldap:
      #github_repo: "hydrian/TTRSS-Auth-LDAP"
      #branch: master
      #commit: 0cc2a21441f99eef8368cfe0fbdbb78126e28d61
      
      # Switch to other repo waiting for https://github.com/hydrian/TTRSS-Auth-LDAP/pull/40
      #github_repo: "marcpaulchand/TTRSS-Auth-LDAP"
      #branch: php8_Auth_Base
      #commit: 557811efa15bab3b5044c98416f9e37264f11c9a

      # Switch, again, to quickly fix an issue, waiting for https://github.com/marcpaulchand/TTRSS-Auth-LDAP/pull/2
      github_repo: "Neraud/TTRSS-Auth-LDAP"
      branch: php8_Auth_Base
      commit: eee2741a3f6e2e096d2d49c988eaf94540f4078d
    mailer_smtp:
      repo_url: "https://git-gitea.tt-rss.org/fox/ttrss-mailer-smtp"
      branch: master
      commit: 0719ebc8fa

  ldap:
    servername: "{{ ttrss_ldap_servername | default(openldap.ldap.servername) }}"
    users_dn: "{{ ttrss_ldap_users_dn | default(openldap.ldap.structure_users_ou_dn) }}"
    manager_dn: "{{ ttrss_ldap_manager_dn | default(openldap.ldap.readonly_user_dn) }}"
    manager_password: "{{ ttrss_ldap_manager_password | default(openldap.ldap.readonly_user_password) }}"
    group: "{{ ttrss_ldap_group }}"

  smtp:
    host: "{{ ttrss_smtp_host | default(zonemta.smtp_servername) }}"
    port: "{{ ttrss_smtp_port | default(587) }}"
    user: "{{ ttrss_smtp_user | default(zonemta.feeder.authentication_username) }}"
    password: "{{ ttrss_smtp_password | default(zonemta.feeder.authentication_password) }}"
    #  ssl, tls or empty
    secure: "{{ ttrss_smtp_secure | default('tls') }}"
    from: "{{ ttrss_smtp_from | default('noreply@' + web_base_domain) }}"
    displayName: "{{ ttrss_smtp_displayName | default('Tiny Tiny RSS') }}"

  daemon:
    # Limit number of jobs to avoid throttling when using a low resources limit. Defaults to 2 in TT-RSS.
    max_jobs: "{{ ttrss_daemon_max_jobs | default('1') }}"

# To avoid loops inside ttrss_pgsql
_ttrss_pgsql_var_loader:
  base_image:
    repo: "docker.io"
    name: "library/postgres"
    tag: "14.2-alpine3.15"

ttrss_pgsql:
  base_image: "{{ _ttrss_pgsql_var_loader.base_image }}"
  private_image:
    repo: "{{ docker_private_registry.url }}"
    name: "tt-rss-{{ _ttrss_pgsql_var_loader.base_image.name | regex_replace('.*/', '') }}"
    tag: "{{ _ttrss_pgsql_var_loader.base_image.tag }}"

  app_backup:
    name: web-ttrss_pgsql
    repository: "{{ restic_apps_backup_repository }}"
    apps_to_stop:
      - name: ttrss-pgsql
        namespace: "{{ _ttrss_var_loader.namespace }}"
        type: statefulset
        replicas: 1
    gluster_volumes:
      - ttrss-pgsql

  labels_def:
    app.kubernetes.io/name: ttrss
    app.kubernetes.io/component: pgsql

  labels_desc:
    app.kubernetes.io/version: "{{ _ttrss_pgsql_var_loader.base_image.tag }}"
    app.kubernetes.io/part-of: ttrss

  container:
    requests_cpu: "{{ ttrss_pgsql_container_requests_cpu | default('50m') }}"
    requests_memory: "{{ ttrss_pgsql_container_requests_memory | default('256Mi') }}"
    limits_cpu: "{{ ttrss_pgsql_container_limits_cpu | default('250m') }}"
    limits_memory: "{{ ttrss_pgsql_container_limits_memory | default('256Mi') }}"

  user: "{{ ttrss_pgsql_user | default('ttrss') }}"
  database: "{{ ttrss_pgsql_database | default('ttrss') }}"
  password: "{{ ttrss_pgsql_password | default('clear_password') }}"
