---

- name: Set mount path
  set_fact:
    nodered_mount_path: "{{ all_volumes['nodered-data']['mount_path'] }}"

- name: Ensure Node-RED folder exists and is writable
  file:
    path: "{{ nodered_mount_path }}/data"
    state: directory
    mode: 0777

- name: Check if Node-RED is already configured
  stat:
    path: "{{ nodered_mount_path }}/data/settings.js"
  register: nodered_settings_file

- name: Configure Node-RED for the fist run
  template:
    src: "{{ role_path }}/app/prepare/{{ item }}.j2"
    dest: "{{ nodered_mount_path }}/data/{{ item }}"
    backup: true
    mode: 0777
  loop:
    - flows.json
  when: not nodered_settings_file.stat.exists
