---

# Until Opendistro is updated with Kibana 7.2, we trigger a bug if we send a request to kibana before it's fully initialized.
# It creates a mapping issue in the .kibana index : https://github.com/elastic/kibana/issues/40133
# The following workaround fixes the mapping issue

- name: Fetch the kibana mapping
  uri:
    url: "https://127.0.0.1:{{ kubernetes_ingress_https_port }}{{ elasticsearch.context_path }}/{{ kibana.elasticsearch.index }}/_mapping"
    method: GET
    headers:
      Host: "infra.{{ web_base_domain }}"
    return_content: yes
    body_format: json
    validate_certs: no
    status_code:
      - 200
    user: "{{ kibana.elasticsearch.user }}"
    password: "{{ kibana.elasticsearch.password }}"
  register: kibana_mapping_result

- name: Extract Kibana index real name
  set_fact:
    kibana_index_real_name: "{{ kibana_mapping_result.json.keys() | first }}"

- name: Workaround the Kibana mapping issue
  uri:
    url: "https://127.0.0.1:{{ kubernetes_ingress_https_port }}{{ elasticsearch.context_path }}/{{ kibana.elasticsearch.index }}/_mapping"
    method: PUT
    headers:
      Host: "infra.{{ web_base_domain }}"
    body:
      properties:
        type:
          type: text
          fielddata: true
    body_format: json
    return_content: no
    validate_certs: no
    status_code:
      - 200
    user: "{{ kibana.elasticsearch.user }}"
    password: "{{ kibana.elasticsearch.password }}"
  changed_when: True
  when:
    - kibana_mapping_result.json[kibana_index_real_name].mappings.properties.type.type == "text"
    - not (kibana_mapping_result.json[kibana_index_real_name].mappings.properties.type.fielddata | default(False))
