---

- name: Get Plex Claim
  uri:
    url: https://plex.tv/api/claim/token.json
    headers:
      x-plex-token: "{{ plex.token }}"
  register: plex_claim_result
  when: plex.token

- name: Extract Plex Claim
  set_fact:
    plex_claim: "{{ plex_claim_result.json.token }}"
  when: plex.token

- name: Deploy Plex
  k8s:
    definition: "{{ lookup(item | regex_search('.j2$') | ternary('template','file'), item) }}"
    state: present
  with_fileglob:
    - "{{ role_path }}/app/deploy/*.yaml*"
  become: yes
  become_user: "{{ kubernetes_user.name }}"
