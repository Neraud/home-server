---
- name: Ensure Kibana namespace exists
  ansible.builtin.import_tasks: ../../app_base_deploy/tasks/custom-namespace.yml
  vars:
    application_namespace: "{{ kibana.namespace }}"

- name: Ensure BusyBox image is up-to-date in the private registry
  ansible.builtin.import_tasks: ../../app_base_deploy/tasks/container-image-private-registry.yml
  vars:
    base_image: "{{ busybox.base_image }}"
    private_image: "{{ busybox.container.image }}"

- name: Ensure Kibana image is up-to-date in the private registry
  ansible.builtin.import_tasks: ../../app_base_deploy/tasks/container-image-private-registry.yml
  vars:
    base_image: "{{ kibana.base_image }}"
    private_image: "{{ kibana.container.image }}"

- name: Deploy Kibana
  kubernetes.core.k8s:
    definition: "{{ lookup(item | regex_search('.j2$') | ternary('template','file'), item) }}"
    state: present
    kubeconfig: "{{ kubeconfig_path }}"
    context: "{{ kubeconfig_context }}"
  with_fileglob:
    - "{{ role_path }}/app/deploy/*.yaml*"

- name: Create Kibana saved objects exporter dir
  ansible.builtin.file:
    path: "{{ kibana.export_saved.script_path | dirname }}"
    state: directory
    owner: "{{ standard_user.name }}"
    group: "{{ standard_user.name }}"
    mode: 0755

- name: Generate Kibana saved objects exporter
  ansible.builtin.template:
    src: "{{ role_path }}/app/kibana_save_objects.py.j2"
    dest: "{{ kibana.export_saved.script_path }}"
    owner: "{{ standard_user.name }}"
    group: "{{ standard_user.name }}"
    mode: 0755

- name: Wait for Kibana to be available
  kubernetes.core.k8s_info:
    kind: StatefulSet
    namespace: "{{ kibana.namespace }}"
    name: kibana
    kubeconfig: "{{ kubeconfig_path }}"
    context: "{{ kubeconfig_context }}"
  register: k8s_result
  until: k8s_result.resources[0].status.readyReplicas | default(0) > 0
  retries: 60
  delay: 10

- name: List Kibana saved objects
  ansible.builtin.set_fact:
    kibana_config_saved_objects_files: "{{ kibana_config_saved_objects_files | default([]) + [ item ] }}"
  with_fileglob:
    - "{{ role_path }}/app/config/saved_objects/*.json*"

- name: Read Kibana saved objects
  ansible.builtin.set_fact:
    kibana_config_contents: "{{ kibana_config_contents | default([]) + [ (lookup(item | regex_search('.j2$') | ternary('template','file'), item) | from_json) ] }}"
  with_items: "{{ kibana_config_saved_objects_files }}"

- name: Check if objects already exist
  ansible.builtin.uri:
    url: "https://{{ kubernetes_nginx_ingress_lb_ip }}:{{ kubernetes_ingress_https_port }}{{ kibana.context_root }}/api/saved_objects/{{ item.1.type }}/{{ item.1.id }}"
    method: GET
    headers:
      Host: "kibana.log.intra.{{ web_base_domain }}"
    return_content: yes
    status_code:
      - 200
      - 404
    validate_certs: no
    force_basic_auth: yes
    user: "{{ kibana.elasticsearch.user }}"
    password: "{{ kibana.elasticsearch.password }}"
  register: existing_kibana_saved_objects
  with_together:
    - "{{ kibana_config_saved_objects_files }}"
    - "{{ kibana_config_contents }}"
  loop_control:
    label: "{{ item.0 }} -> {{ item.1.id }}"

- name: Create missing objects
  ansible.builtin.uri:
    url: "https://{{ kubernetes_nginx_ingress_lb_ip }}:{{ kubernetes_ingress_https_port }}{{ kibana.context_root }}/api/saved_objects/{{ item.1.type }}/{{ item.1.id }}"
    method: POST
    headers:
      Host: "kibana.log.intra.{{ web_base_domain }}"
      kbn-xsrf: kbn-xsrf
    body:
      attributes: "{{ item.1.attributes }}"
    body_format: json
    validate_certs: no
    force_basic_auth: yes
    user: "{{ kibana.elasticsearch.user }}"
    password: "{{ kibana.elasticsearch.password }}"
  with_together:
    - "{{ kibana_config_saved_objects_files }}"
    - "{{ kibana_config_contents }}"
    - "{{ existing_kibana_saved_objects.results }}"
  loop_control:
    label: "{{ item.0 }} -> {{ item.1.id }}"
  changed_when: True
  when: item.2.status == 404

- name: Updating changed objects
  ansible.builtin.uri:
    url: "https://{{ kubernetes_nginx_ingress_lb_ip }}:{{ kubernetes_ingress_https_port }}{{ kibana.context_root }}/api/saved_objects/{{ item.1.type }}/{{ item.1.id }}"
    method: PUT
    headers:
      Host: "kibana.log.intra.{{ web_base_domain }}"
      kbn-xsrf: kbn-xsrf
    body:
      attributes: "{{ item.1.attributes }}"
    body_format: json
    validate_certs: no
    force_basic_auth: yes
    user: "{{ kibana.elasticsearch.user }}"
    password: "{{ kibana.elasticsearch.password }}"
  with_together:
    - "{{ kibana_config_saved_objects_files }}"
    - "{{ kibana_config_contents }}"
    - "{{ existing_kibana_saved_objects.results }}"
  loop_control:
    label: "{{ item.0 }} -> {{ item.1.id }}"
  changed_when: True
  when:
    - item.2.status == 200
    - item.2.json.attributes != item.1.attributes
