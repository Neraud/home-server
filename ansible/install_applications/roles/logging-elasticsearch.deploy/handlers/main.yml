---

- name: Wait for EasticSearch to be available
  uri:
    url: "https://127.0.0.1:{{ kubernetes_ingress_https_port }}{{ elasticsearch.context_path }}/_cluster/state"
    method: GET
    headers:
      Host: "infra.{{ web_base_domain }}"
    return_content: yes
    validate_certs: no
    status_code:
      - 200
      - 403
      - 503
    user: "{{ elasticsearch.exporter.user }}"
    password: "{{ elasticsearch.exporter.password }}"
  register: elasticsearch_available
  until:
  - (elasticsearch_available.status == 200) or (elasticsearch_available.status == 403) or (elasticsearch_available.status == 503 and "Open Distro Security not initialized" in elasticsearch_available.content)
  retries: 18
  delay: 10
  listen: "Reconfigure Elasticsearch security"

# Security configuration changes are only taken into account the first time ES is deployed, or after running securityadmin.sh
# The following tasks ensures that each time something changes in ES deployment, security configurations are properly updated.
- name: Reconfigure security
  command:
    kubectl --namespace=logging exec -it elasticsearch-0 -- \
      bash /usr/share/elasticsearch/plugins/opendistro_security/tools/securityadmin.sh \
      -icl -nhnv \
      -cd /usr/share/elasticsearch/plugins/opendistro_security/securityconfig/ \
      -cacert /usr/share/elasticsearch/config/certs/ca.crt \
      -cert /usr/share/elasticsearch/config/certs/server.crt \
      -key /usr/share/elasticsearch/config/certs/server.key
  become: yes
  become_user: "{{ kubernetes_user.name }}"
  listen: "Reconfigure Elasticsearch security"
