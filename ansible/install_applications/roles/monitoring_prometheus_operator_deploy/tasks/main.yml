---
- name: Ensure Prometheus namespace exists
  ansible.builtin.import_tasks: ../../app_base_deploy/tasks/custom-namespace.yml
  vars:
    application_namespace: "{{ prometheus.namespace }}"

- name: Ensure BusyBox image is up-to-date in the private registry
  ansible.builtin.import_tasks: ../../app_base_deploy/tasks/container-image-private-registry.yml
  vars:
    base_image: "{{ busybox.base_image }}"
    private_image: "{{ busybox.private_image }}"

- name: Ensure Prometheus Operator image is up-to-date in the private registry
  ansible.builtin.import_tasks: ../../app_base_deploy/tasks/container-image-private-registry.yml
  vars:
    base_image: "{{ prometheus_operator.base_image }}"
    private_image: "{{ prometheus_operator.private_image }}"

- name: Ensure Prometheus image is up-to-date in the private registry
  ansible.builtin.import_tasks: ../../app_base_deploy/tasks/container-image-private-registry.yml
  vars:
    base_image: "{{ prometheus.base_image }}"
    private_image: "{{ prometheus.private_image }}"

- name: Ensure AlertManager image is up-to-date in the private registry
  ansible.builtin.import_tasks: ../../app_base_deploy/tasks/container-image-private-registry.yml
  vars:
    base_image: "{{ alertmanager.base_image }}"
    private_image: "{{ alertmanager.private_image }}"

- name: Deploy Prometheus Operator
  kubernetes.core.k8s:
    definition: "{{ lookup(item | regex_search('.j2$') | ternary('template','file'), item) }}"
    state: present
    kubeconfig: "{{ kubeconfig_path }}"
    context: "{{ kubeconfig_context }}"
  with_fileglob:
    - "{{ role_path }}/app/deploy/operator/*.yaml*"

- name: Deploy Prometheus
  kubernetes.core.k8s:
    definition: "{{ lookup(item | regex_search('.j2$') | ternary('template','file'), item) }}"
    state: present
    kubeconfig: "{{ kubeconfig_path }}"
    context: "{{ kubeconfig_context }}"
  with_fileglob:
    - "{{ role_path }}/app/deploy/prometheus/*.yaml*"

- name: List AlertManager config files
  ansible.builtin.set_fact:
    alertmanager_config_files: "{{ alertmanager_config_files | default([]) + [ item ] }}"
  with_fileglob:
    - "{{ role_path }}/app/config/alertmanager/*"

- name: Deploy AlertManager
  kubernetes.core.k8s:
    definition: "{{ lookup(item | regex_search('.j2$') | ternary('template','file'), item) }}"
    state: present
    kubeconfig: "{{ kubeconfig_path }}"
    context: "{{ kubeconfig_context }}"
  with_fileglob:
    - "{{ role_path }}/app/deploy/alertmanager/*.yaml*"

- name: Deploy Prometheus ServiceMonitors
  kubernetes.core.k8s:
    definition: "{{ lookup(item | regex_search('.j2$') | ternary('template','file'), item) }}"
    state: present
    kubeconfig: "{{ kubeconfig_path }}"
    context: "{{ kubeconfig_context }}"
  with_fileglob:
    - "{{ role_path }}/app/deploy/service-monitors/*.yaml*"

- name: List Prometheus rules files from custom
  ansible.builtin.set_fact:
    prometheus_rules_custom: "{{ prometheus_rules_custom | default([]) + [ item ] }}"
  with_fileglob:
    - "{{ role_path }}/app/config/prometheus/rules/custom/*"

- name: List Prometheus rules files from gluster-mixin
  ansible.builtin.set_fact:
    prometheus_rules_gluster_mixin: "{{ prometheus_rules_gluster_mixin | default([]) + [ item ] }}"
  with_fileglob:
    - "{{ role_path }}/app/config/prometheus/rules/gluster-mixin/*"

- name: List Prometheus rules files from kube-prometheus
  ansible.builtin.set_fact:
    prometheus_rules_kube_prometheus: "{{ prometheus_rules_kube_prometheus | default([]) + [ item ] }}"
  with_fileglob:
    - "{{ role_path }}/app/config/prometheus/rules/kube-prometheus/*"

- name: List Prometheus rules files from longhorn
  ansible.builtin.set_fact:
    prometheus_rules_longhorn: "{{ prometheus_rules_longhorn | default([]) + [ item ] }}"
  with_fileglob:
    - "{{ role_path }}/app/config/prometheus/rules/longhorn/*"

- name: Deploy Prometheus Rules
  kubernetes.core.k8s:
    definition: "{{ lookup(item | regex_search('.j2$') | ternary('template','file'), item) }}"
    namespace: "{{ prometheus.namespace }}"
    state: present
    kubeconfig: "{{ kubeconfig_path }}"
    context: "{{ kubeconfig_context }}"
  with_fileglob:
    - "{{ role_path }}/app/deploy/rules/*.yaml*"

- name: Deploy Ingress
  kubernetes.core.k8s:
    definition: "{{ lookup(item | regex_search('.j2$') | ternary('template','file'), item) }}"
    state: present
    kubeconfig: "{{ kubeconfig_path }}"
    context: "{{ kubeconfig_context }}"
  with_fileglob:
    - "{{ role_path }}/app/deploy/*.yaml*"
