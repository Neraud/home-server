---
elasticeach_index_templates:
- name: default
  index_pattern: "*"
  index_regexp: ".*"
  priority: 1
  settings:
    # By default, an index is created with 1 replica.
    # If we only have 1 node, this index will remain yellow
    number_of_replicas: "{{ (elasticsearch.replicas|int > 1) | ternary(1, 0) }}"
- name: logstash
  index_pattern: "logstash-*"
  index_regexp: "logstash-.*"
  priority: 10
  settings:
    # By default, an index is created with 1 replica.
    # If we only have 1 node, this index will remain yellow
    number_of_replicas: "{{ (elasticsearch.replicas|int > 1) | ternary(1, 0) }}"
    # After 30 seconds without search, an index is flagged idle and not refresh automatically
    # Our prometheus exporter won't see new documents and trigger a ElasticNoNewDocuments alert when this happens
    # To avoid that, we force the scheduled refresh
    refresh_interval: "10s"

elasticsearch_index_policies:
- policy_id: "hot-cold-delete"
  description: A Logstash policy that handles hot / cold / delete states.
  ism_template:
  - index_patterns: [ "logstash-*" ]
    priority: 100
  default_state: hot
  states:
  - name: hot
    actions:
    - open: {}
      retry:
        backoff: exponential
        count: 3
        delay: 1m
    transitions:
    - state_name: cold
      conditions:
        min_index_age: "{{ elasticsearch.logstash_policy.cold_age }}"
  - name: cold
    actions:
    - read_only: {}
      retry:
        backoff: exponential
        count: 3
        delay: 1m
    - replica_count:
        number_of_replicas: 0
      retry:
        backoff: exponential
        count: 3
        delay: 1m
    transitions:
    - state_name: delete
      conditions:
        min_index_age: "{{ elasticsearch.logstash_policy.delete_age }}"
  - name: delete
    actions:
    - delete: {}
      retry:
        backoff: exponential
        count: 3
        delay: 1m
    transitions: []
