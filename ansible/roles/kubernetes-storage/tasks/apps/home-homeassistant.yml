---

- name: Set mount path
  set_fact:
    homeassistant_mount_path: "{{ kubernetes_local_storage['homeassistant-config']['mount_path'] }}"

- name: Check if HomeAssistant is already configured
  stat:
    path: "{{ homeassistant_mount_path }}/configuration.yaml"
  register: homeassistant_configuration_file

- name: Configure HomeAssistant for the fist run
  template:
    src: "{{ kubernetes_app_root_path }}/home/homeassistant/prepare/{{ item }}.j2"
    dest: "{{ homeassistant_mount_path }}/{{ item }}"
    backup: true
  loop:
    - automations.yaml
    - configuration.yaml
    - secrets.yaml
  when: not homeassistant_configuration_file.stat.exists

- name: Create empty included files to configure HomeAssistant
  copy:
    content: ""
    dest: "{{ homeassistant_mount_path }}/{{ item }}"
    force: no
  loop:
    - customize.yaml
    - groups.yaml
    - scripts.yaml
  when: not homeassistant_configuration_file.stat.exists
