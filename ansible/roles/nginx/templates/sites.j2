#jinja2: trim_blocks: "true", lstrip_blocks: "false"
# {{ ansible_managed }}

{% if item.http_port | default(False) %}
server {
	listen {{ nginx_listen_ip }}:{{ item.http_port }}{% if item.default | default(False) %} default_server{% endif %};
	listen [::]:{{ item.http_port }}{% if item.default | default(False) %} default_server{% endif %};
	server_name {% if item.default | default(False) %}_ {% endif %}{{ item.server_name | default("_") }};
	root /var/www/html;
	
	access_log /var/log/nginx/{{ item.name }}_access.log main;
	error_log /var/log/nginx/{{ item.name }}_error.log;	
	
	{% if item.default | default(False) %}
	location /nginx_status {
		stub_status on;
		access_log off;
		allow 127.0.0.1;
		allow ::1;
		deny all;
	}
	{% endif %}
		
	{% if item.https_cert is defined and item.https_cert.mode == "letsencrypt" %}
	location /.well-known {
    	alias {{ item.https_cert.docroot }}/.well-known;
    }
	{% endif %}
	
	{% if item.force_http_to_https | default(False) %}
	location / { rewrite ^ https://$server_name$request_uri? permanent; }
	{% else %}
	index index.html index.htm index.nginx-debian.html;
		
		{% if item.disable_robots %}
	location /robots.txt { alias {{ nginx_default_disabled_robots_path }}; }
		{% endif %}
		
		{% if item.lemonLdap is defined %}
	# Internal authentication request
	location = {{ item.lemonLdap.path | default("/lmauth") }} {
		internal;
		include /etc/nginx/fastcgi_params;
		fastcgi_pass {{ item.lemonLdap.proxy_pass }};

		# Drop post datas
		fastcgi_pass_request_body  off;
		fastcgi_param CONTENT_LENGTH "";

		# Keep original hostname
		fastcgi_param HOST $http_host;

		# Keep original request (LLNG server will received {{ item.lemonLdap.path | default("/lmauth") }})
		fastcgi_param X_ORIGINAL_URI  $request_uri;

		fastcgi_buffers 16 16k;
		fastcgi_buffer_size 32k;
	}
		{% endif %}
			
		{% for location in item.locations | default() %}
	location {{ location.path }} {
			{% if location.root is defined %}
		root {{ location.root }};
			{% endif %}
			{% if location.alias is defined %}
		alias {{ location.alias }};
			{% endif %}
			{% if location.proxy_pass is defined %}
		include custom_proxy_params;
		proxy_pass {{ location.proxy_pass }};
			{% endif %}
			{% if location.proxy_enable_websocket is defined and location.proxy_enable_websocket %}
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection "upgrade";
			{% endif %}
			{% if location.auth_basic is defined %}
		auth_basic "{{ location.auth_basic.name }}";
		auth_basic_user_file {{ location.auth_basic.path }};
		proxy_set_header Authorization "";
			{% endif %}
			{% if location.lemonLdap_protected | default(false) %}
		auth_request {{ item.lemonLdap.path | default("/lmauth") }};
		auth_request_set $lmremote_user $upstream_http_lm_remote_user;
		auth_request_set $lmlocation $upstream_http_location;
		error_page 401 $lmlocation;
			{% endif %}
			
			{% if location.php_fpm_pool is defined %}
		index index.php index.html index.htm;
		location ~ \.php$ {
			include        fastcgi.conf;
			fastcgi_pass   {{ location.php_fpm_pool }};
			fastcgi_index index.php;
			fastcgi_param SCRIPT_FILENAME $request_filename;
        }
			{% endif %}
			
			{% if location.content is defined %}
		{{ location.content }}
			{% endif %}
	}
		{% endfor %}
	{% endif %}	
}

{% endif %}

{% if item.https_port | default(False) %}
server {
	listen {{ nginx_listen_ip }}:{{ item.https_port }} ssl{% if item.default | default(False) %} default_server{% endif %};
	listen [::]:{{ item.https_port }} ssl{% if item.default | default(False) %} default_server{% endif %};
	server_name {% if item.default | default(False) %}_ {% endif %}{{ item.server_name | default("_") }};
	root /var/www/html;

	access_log /var/log/nginx/{{ item.name }}_ssl_access.log main;
	error_log /var/log/nginx/{{ item.name }}_ssl_error.log;

	# SSL configuration
	ssl on;
	{% if item.https_cert.mode == "file" or item.https_cert.mode == "selfsigned" %}
	ssl_certificate {{ item.https_cert.cert_path }};
	ssl_certificate_key {{ item.https_cert.cert_key_path }};
	{% elif item.https_cert.mode == "letsencrypt" %}
	ssl_certificate /etc/letsencrypt/live/{{ item.server_name }}/fullchain.pem;
	ssl_certificate_key /etc/letsencrypt/live/{{ item.server_name }}/privkey.pem;
	{% endif %}
	
	ssl_session_timeout 1d;
	ssl_session_cache shared:SSL:50m;
	ssl_session_tickets off;
	
	{% if nginx_ssl_dhparam_generate %}
	ssl_dhparam {{ nginx_ssl_dhparam_path }};
	{% endif %}

    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers 'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS';
    ssl_prefer_server_ciphers on;
	
	{% if item.default | default(False) %}
	location /nginx_status {
		stub_status on;
		access_log off;
		allow 127.0.0.1;
		allow ::1;
		deny all;
	}
	{% endif %}

	index index.html index.htm index.nginx-debian.html;
		
	{% if item.disable_robots %}
	location /robots.txt { alias {{ nginx_default_disabled_robots_path }}; }
	{% endif %}

	{% if item.lemonLdap is defined %}
	# Internal authentication request
	location = {{ item.lemonLdap.path | default("/lmauth") }} {
		internal;
		include /etc/nginx/fastcgi_params;
		fastcgi_pass {{ item.lemonLdap.proxy_pass }};

		# Drop post datas
		fastcgi_pass_request_body  off;
		fastcgi_param CONTENT_LENGTH "";

		# Keep original hostname
		fastcgi_param HOST $http_host;

		# Keep original request (LLNG server will received {{ item.lemonLdap.path | default("/lmauth") }})
		fastcgi_param X_ORIGINAL_URI  $request_uri;
		
		fastcgi_buffers 16 16k;
		fastcgi_buffer_size 32k;
	}
	{% endif %}

		{% for location in item.locations | default() %}
	location {{ location.path }} {
			{% if location.root is defined %}
		root {{ location.root }};
			{% endif %}
			{% if location.alias is defined %}
		alias {{ location.alias }};
			{% endif %}
			{% if location.proxy_pass is defined %}
		include custom_proxy_params;
		proxy_pass {{ location.proxy_pass }};
			{% endif %}
			{% if location.proxy_enable_websocket is defined and location.proxy_enable_websocket %}
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection "upgrade";
			{% endif %}
			{% if location.auth_basic is defined %}
		auth_basic "{{ location.auth_basic.name }}";
		auth_basic_user_file {{ location.auth_basic.path }};
		proxy_set_header Authorization "";
			{% endif %}
			{% if location.lemonLdap_protected | default(false) %}
		auth_request {{ item.lemonLdap.path | default("/lmauth") }};
		auth_request_set $lmremote_user $upstream_http_lm_remote_user;
		auth_request_set $lmlocation $upstream_http_location;
		error_page 401 $lmlocation;
			{% endif %}
			
			{% if location.php_fpm_pool is defined %}
		index index.php index.html index.htm;
		location ~ \.php$ {
			include        fastcgi.conf;
			fastcgi_pass   {{ location.php_fpm_pool }};
			fastcgi_index index.php;
			fastcgi_param SCRIPT_FILENAME $request_filename;
        }
			{% endif %}
			
			{% if location.content is defined %}
		{{ location.content }}
			{% endif %}
	}
		{% endfor %}
}
{% endif %}
