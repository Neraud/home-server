---

- name: Get Plex Claim
  uri:
    url: https://plex.tv/api/claim/token.json
    headers:
      x-plex-token: "{{ plex_plex_token }}"
  register: plex_claim_result
  when: plex_plex_token is defined

- name: Extract Plex Claim
  set_fact:
    plex_claim: "{{ plex_claim_result.json.token }}"
  when: plex_plex_token is defined

- name: Deploy Plex
  k8s:
    definition: "{{ lookup('template', kubernetes_app_root_path + '/stream/plex/deploy/' + item) }}"
    state: present
  with_items:
    - frontend.yaml.j2
    - ingress.yaml.j2
  become: yes
  become_user: "{{ kubernetes_user.name }}"
