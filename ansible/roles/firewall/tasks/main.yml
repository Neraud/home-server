---

- name: Search for iptables-legacy
  stat:
    path: /usr/sbin/iptables-legacy
  register: iptables_legacy_stat

# Cf https://github.com/kubernetes/kubernetes/issues/71305#issuecomment-479558920
- name: Force iptables to legacy mode on Buster
  alternatives:
    path: /usr/sbin/iptables-legacy
    name: iptables
  when: 
    - ansible_lsb.codename == "buster"
    - iptables_legacy_stat.stat.exists

- name: Install ufw
  apt:
    pkg: ufw
    state: present

- name: Allow ssh
  ufw:
    name: OpenSSH
    rule: allow

- name: Enable ufw
  ufw:
    state: enabled

- name: Set ufw policy to deny all incoming connections
  ufw:
    policy: deny
    direction: incoming

- name: Set ufw policy to allow all ougoing connections
  ufw:
    policy: allow
    direction: outgoing

- name: Declare custom applications
  template:
    src: application.j2
    dest: /etc/ufw/applications.d/{{ item.name }}
  with_items: "{{ firewall_applications }}"

- name: Allow custom applications
  ufw:
    name: "{{ item.name }}"
    rule: "{{ item.rule }}"
    src: "{{ item.src | default('any') }}"
  with_items: "{{ firewall_applications }}"
