#!/usr/bin/env bash

# {{ ansible_managed }}

set -euo pipefail

{% if restic_host_backup_repository.enabled %}

export RESTIC_REPOSITORY="{{ restic_host_backup_repository.repository }}"
export RESTIC_PASSWORD="{{ restic_host_backup_repository.password }}"

echo ""
echo "Testing if the repository already exists"

set +e
restic stats
restic_repo_status=$?
set -e

if [ $restic_repo_status -eq 0 ] ; then
    echo ""
    echo "Ok, repo already exists, continuing"
else
    echo ""
    echo "Repository doesn't exists, creating"
    restic init
fi

echo ""
echo "Backing up paths"
    {% for path in restic_host_backup_repository.paths %}
echo "===================================================================================================="
echo " - {{ path }}"
restic backup {{ path }}
    {% endfor %}

{% else %}
echo "Host backup disabled"
{% endif %}
