#!/usr/bin/env bash

# {{ ansible_managed }}

set -euo pipefail

{% if restic_repositories_maintenance_enabled %}
echo "Running maintenance on repositories"

    {% for repo in restic_repositories %}
echo "===================================================================================================="
echo " - {{ repo.name }}"

        {% if repo.enabled and repo.retention %}
export RESTIC_REPOSITORY="{{ repo.repository }}"
export RESTIC_PASSWORD="{{ repo.password }}"

echo ""
echo "Checking data ..."
restic check --read-data

{% set keep_configs = [] %}
{% if 'keep_last' in repo.retention and repo.retention.keep_last > 0 %}{{ keep_configs.append("--keep-last " ~ repo.retention.keep_last) }}{% endif %}
{% if 'keep_hourly' in repo.retention and repo.retention.keep_hourly > 0 %}{{ keep_configs.append("--keep-hourly " ~ repo.retention.keep_hourly) }}{% endif %}
{% if 'keep_daily' in repo.retention and repo.retention.keep_daily > 0 %}{{ keep_configs.append("--keep-daily " ~ repo.retention.keep_daily) }}{% endif %}
{% if 'keep_weekly' in repo.retention and repo.retention.keep_weekly > 0 %}{{ keep_configs.append("--keep-weekly " ~ repo.retention.keep_weekly) }}{% endif %}
{% if 'keep_monthly' in repo.retention and repo.retention.keep_monthly > 0 %}{{ keep_configs.append("--keep-monthly " ~ repo.retention.keep_monthly) }}{% endif %}
{% if 'keep_yearly' in repo.retention and repo.retention.keep_yearly > 0 %}{{ keep_configs.append("--keep-yearly " ~ repo.retention.keep_yearly) }}{% endif %}
{% if 'keep_tags' in repo.retention %}{% for tag in repo.retention.keep_tags %}{{ keep_configs.append("--keep-tag " ~ tag) }}{% endfor %}{% endif %}
{% if 'keep_within' in repo.retention and repo.retention.keep_within != "" %}{{ keep_configs.append("--keep-within " ~ repo.retention.keep_within) }}{% endif %}

echo ""
echo "Forgetting old snapshot with settings : {{ " ".join(keep_configs) }}"
restic forget {{ " ".join(keep_configs) }}

echo ""
echo "Pruning"
restic prune
        {% elif not repo.enabled %}
echo "Repisory is disabled, nothing to do ..."
        {% else %}
echo "Retention not configured, nothing to do ..."
        {% endif %}
    {% endfor %}

{% else %}
echo "Repositories maintenance disabled"
{% endif %}
