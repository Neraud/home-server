---

- name: Deploy Apps backup scripts
  template:
    src: "backup_apps.sh.j2"
    dest: "{{ restic_backup_scripts_dir }}/backup_apps.sh"
    mode: 0700
  when: restic_backup_apps_enabled

- name: Ensure Restic apps backup scripts directory exists
  file:
    path: "{{ restic_backup_apps_scripts_dir }}"
    state: directory
    mode: 0700
  when: restic_backup_apps_enabled

- name: Ensure Host backup scripts are absent
  file:
    path: "{{ restic_backup_scripts_dir }}/backup_apps.sh"
    state: absent
  when: not restic_backup_apps_enabled

- name: Schedule apps backup
  cron:
    name: "restic_apps_backup"
    cron_file: "restic"
    user: root
    job: "{{ restic_backup_scripts_dir }}/backup_apps.sh"
    minute: "{{ restic_backup_apps_cron.minute }}"
    hour: "{{ restic_backup_apps_cron.hour }}"
    day: "{{ restic_backup_apps_cron.day }}"
    weekday: "{{ restic_backup_apps_cron.weekday }}"
    month: "{{ restic_backup_apps_cron.month }}"
  when: 
    - schedule_with_cron
    - restic_backup_apps_enabled and restic_backup_apps_cron

- name: Ensure apps backup is not scheduled
  cron:
    name: "restic_apps_backup"
    cron_file: "restic"
    state: absent
  when: 
    - schedule_with_cron
    - not restic_backup_apps_cron or not restic_backup_apps_cron
  