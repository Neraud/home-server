---

- name: Deploy repo maintenance scripts
  template:
    src: "repo_maintenance.sh.j2"
    dest: "{{ restic_backup_scripts_dir }}/repo_maintenance.sh"
    mode: 0700
  when: restic_backup_maintenance_enabled

- name: Ensure repo maintenance scripts are absent
  file:
    path: "{{ restic_backup_scripts_dir }}/repo_maintenance.sh"
    state: absent
  when: not restic_backup_maintenance_enabled

- name: Schedule repositories maintenance
  cron:
    name: "restic_repo_maintenance"
    cron_file: "restic"
    user: root
    job: "{{ restic_backup_scripts_dir }}/repo_maintenance.sh"
    minute: "{{ restic_backup_maintenance_cron.minute }}"
    hour: "{{ restic_backup_maintenance_cron.hour }}"
    day: "{{ restic_backup_maintenance_cron.day }}"
    weekday: "{{ restic_backup_maintenance_cron.weekday }}"
    month: "{{ restic_backup_maintenance_cron.month }}"
  when: 
    - schedule_with_cron
    - restic_backup_maintenance_enabled and restic_backup_maintenance_cron

- name: Ensure repo maintenance is not scheduled
  cron:
    name: "restic_repo_maintenance"
    cron_file: "restic"
    state: absent
  when: 
    - schedule_with_cron
    - not restic_backup_maintenance_enabled or not restic_backup_maintenance_cron
  