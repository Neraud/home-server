---

# moreutils is required for sponge
- name: Ensure moreutils is installed
  apt:
    pkg: moreutils
    state: present

- name: Ensure textfile collector directory exists
  file:
    path: "{{ textfile_collector_directory }}"
    state: directory

- name: Ensure textfile collector script directory exists
  file:
    path: "{{ textfile_collector_scripts_directory }}"
    state: directory

- name: Deploy collectors
  template:
    src: "collectors/{{ item.script }}.j2"
    dest: "{{ textfile_collector_scripts_directory }}/{{ item.script }}"
    mode: 0755
  loop: "{{ textfile_collectors | default([]) }}"

- name: Create collectors cron jobs
  cron:
    name: "{{ item.name }}"
    cron_file: "textfile_collectors"
    user: "{{ item.user | default('root') }}"
    job: "{{ textfile_collector_scripts_directory }}/{{ item.script }} | sponge {{ textfile_collector_directory }}/{{ item.name | lower | regex_replace('[^a-zA-Z0-9_-]', '_') }}.prom"
    minute: "{{ item.minute }}"
    hour: "{{ item.hour }}"
    day: "{{ item.day }}"
    weekday: "{{ item.weekday }}"
    month: "{{ item.month }}"
  loop: "{{ textfile_collectors | default([]) }}"
