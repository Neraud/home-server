---
- name: Install GO requirements
  ansible.builtin.apt:
    pkg:
      - golang-go
    state: present

- name: Install build requirements
  ansible.builtin.command: "{{ item }}"
  environment:
    GOPATH: "{{ gluster_prometheus_exporter_go_path }}"
  loop:
    - "go get -u github.com/golang/dep/cmd/dep"
    - "go get github.com/alecthomas/gometalinter"
  register: build_dependencies_result
  changed_when: "build_dependencies_result.stdout_lines | length > 0"

# ansible-lint warns : [no-handler] Tasks that run when changed should likely be handlers
# But it's not a handler, we just want to only trigger a new install if gometalinter has been updated
- name: Install gometalinter
  ansible.builtin.command: "{{ gluster_prometheus_exporter_go_path }}/bin/gometalinter --install --update"
  environment:
    GOPATH: "{{ gluster_prometheus_exporter_go_path }}"
  when: build_dependencies_result.changed # noqa no-handler

- name: Clone Gluster Prometheus Exporter repo
  ansible.builtin.git:
    repo: https://github.com/gluster/gluster-prometheus.git
    dest: "{{ gluster_prometheus_exporter_go_path }}/src/github.com/gluster/gluster-prometheus"
    version: c6f2211963df5e5cd613c7bfdfb8319fdce922c4
  register: clone_gluster_prometheus_result

# ansible-lint warns : [no-handler] Tasks that run when changed should likely be handlers
# But it's not a handler, we just want to only trigger a new make if files have changed
- name: Make Gluster Prometheus Exporter
  community.general.make:
    chdir: "{{ gluster_prometheus_exporter_go_path }}/src/github.com/gluster/gluster-prometheus"
    params:
      PREFIX: /usr
  environment:
    GOPATH: "{{ gluster_prometheus_exporter_go_path }}"
    PATH: "{{ ansible_env.PATH }}:{{ gluster_prometheus_exporter_go_path }}/bin"
  when: build_dependencies_result.changed or clone_gluster_prometheus_result.changed # noqa no-handler
  notify: Restart Gluster Prometheus Exporter

# ansible-lint warns : [no-handler] Tasks that run when changed should likely be handlers
# But it's not a handler, we just want to only trigger a new make if files have changed
- name: Install Gluster Prometheus Exporter
  community.general.make:
    chdir: "{{ gluster_prometheus_exporter_go_path }}/src/github.com/gluster/gluster-prometheus"
    target: install
    params:
      PREFIX: /usr
  environment:
    GOPATH: "{{ gluster_prometheus_exporter_go_path }}"
    PATH: "{{ ansible_env.PATH }}:{{ gluster_prometheus_exporter_go_path }}/bin"
  when: build_dependencies_result.changed or clone_gluster_prometheus_result.changed # noqa no-handler
  notify: Restart Gluster Prometheus Exporter
  become: yes

- name: Configure Gluster Prometheus Exporter
  ansible.builtin.template:
    src: gluster-exporter.toml.j2
    dest: /etc/gluster-exporter/gluster-exporter.toml
    mode: 0600
  notify: Restart Gluster Prometheus Exporter

- name: Prepare Gluster Prometheus Exporter service override
  ansible.builtin.file:
    path: /etc/systemd/system/gluster-exporter.service.d
    state: directory
    mode: 0755

- name: Configure Gluster Prometheus Exporter service
  ansible.builtin.template:
    src: gluster-exporter_override.service.j2
    dest: /etc/systemd/system/gluster-exporter.service.d/override.conf
    mode: 0644
  notify: Restart Gluster Prometheus Exporter

- name: Auto-start gluster-exporter
  ansible.builtin.service:
    name: gluster-exporter.service
    state: started
    enabled: yes
