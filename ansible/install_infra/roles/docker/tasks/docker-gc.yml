---
- name: Install docker-gc requirements
  ansible.builtin.apt:
    pkg:
      - git-core
      - devscripts
      - debhelper
      - build-essential
      - dh-make
    state: present

- name: Clone docker-gc repo
  ansible.builtin.git:
    dest: "{{ docker_gc_path }}/docker-gc"
    repo: https://github.com/spotify/docker-gc
    version: 1e4dbcf1f683670432914be6701d22a0da82a530
  register: docker_gc_clone_result

  # ansible-lint warns : [no-handler] Tasks that run when changed should likely be handlers
  # But it's not a handler, we just want to only trigger a new build if docker-gc has been updated
- name: Build docker-gc
  ansible.builtin.command: debuild -us -uc -b
  args:
    chdir: "{{ docker_gc_path }}/docker-gc"
  when: docker_gc_clone_result.changed # noqa no-handler

- name: Install docker-gc
  ansible.builtin.apt:
    deb: "{{ docker_gc_path }}/docker-gc_0.2.0_all.deb"

- name: Generate docker-gc cron
  ansible.builtin.cron:
    name: docker-gc
    cron_file: docker-gc
    user: root
    special_time: daily
    job: /usr/sbin/docker-gc
