apiVersion: kubeadm.k8s.io/v1beta2
kind: ClusterConfiguration
clusterName: {{ kubernetes_cluster_name }}
{% if kubernetes_control_plane_version_override is defined %}
kubernetesVersion: {{ kubernetes_control_plane_version_override }}
{% endif %}
controlPlaneEndpoint: {{ kubernetes_apiserver_bind_ip }}:{{ haproxy_kubernetes_apiserver_port }}
networking:
  podSubnet: {{ kubernetes_pod_network_cidr }}

# To allow Prometheus to gather metrics from kube controllerManager and scheduler,
# we need to bind on 0.0.0.0 and not the default 127.0.0.1
controllerManager:
  extraArgs:
    bind-address: 0.0.0.0
scheduler:
  extraArgs:
    bind-address: 0.0.0.0

---

apiVersion: kubeadm.k8s.io/v1beta2
kind: InitConfiguration
localAPIEndpoint:
{% if kubernetes_apiserver_ip is defined %}
  advertiseAddress: "{{ kubernetes_apiserver_ip }}"
{% endif %}

---

apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
cgroupDriver: systemd
# TODO : Fix kubelet serving certificate
# Enabling serverTLSBootstrap allows Kubelet to have proper serving certificates
# However, it requires to manually accept them (`kubectl get csr`, `kubectl certificate approve`
# See https://github.com/kubernetes/kubeadm/issues/1223
#serverTLSBootstrap: true

# avoid "Failed to start ContainerManager failed to initialise top level QOS containers" error (ref: https://github.com/kubernetes/kubernetes/issues/43856)
# avoid "kubelet crashes with: root container [kubepods] doesn't exist" (ref: https://github.com/kubernetes/kubernetes/issues/95488)
# Also configured in kubernetes_kubelet_extra_parameters
cgroupsPerQOS: false
enforceNodeAllocatable: []

---

apiVersion: kubeproxy.config.k8s.io/v1alpha1
kind: KubeProxyConfiguration
# To allow Prometheus to gather metrics from kube-proxy,
# we need to bind on 0.0.0.0 and not the default 127.0.0.1
metricsBindAddress: 0.0.0.0:10249
